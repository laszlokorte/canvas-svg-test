<!DOCTYPE html>
<html>
	<head>
    <meta charset="utf-8" />
		<title>FSM per SVG</title>
    <link rel="stylesheet" href="style.css" />
	</head>
	<body>
    <h1>SVG</h1>

    <svg id="stage" width="800" height="600"></svg>

    <script type="text/javascript" src="common.js"></script>
    <script type="text/javascript">
      function setup(stage) {

        var states = [
          {
            pos: {x: 200, y: 200},
            transitions: [
              {target: 1},
              {target: 0}
            ]
          },
          {
            pos: {x: 500, y: 480},
            transitions: [
              {target: 2},
              {target: 0}
            ]
          },
          {
            pos: {x: 900, y: 280},
            transitions: [
              {target: 1}
            ]
          },
          {
            pos: {x: 600, y: 80},
            transitions: [
              {target: 0},
              {target: 2}
            ]
          }
          ,
          {
            pos: {x: 1000, y: 80},
            transitions: [
              {target: 0},
              {target: 2}
            ]
          }
        ];

        var step = function(val, size) {
          return Math.round(val / size) * size;
        }

        var render = function() {
          var width = stage.getAttribute('width');
          var height = stage.getAttribute('height');

          clearSVG(stage);
          stage.setAttribute('viewBox', '0 0 '+ width + ' ' + height);

          for(var i=0,j=states.length;i<j;i++) {
            var state = states[i];
            var circle = appendToSVG(stage,'circle',{'cx':state.pos.x, 'cy':state.pos.y, r:70, class: 'state' + (dragState.activeState===i ? ' active' : ''), 'stroke-width': '5'});
            circle.setAttribute('stateIdx', i);
          }

          for(var i=0,j=states.length;i<j;i++) {
            var state = states[i];
            var transitions = state.transitions;

            for(var p=0,q=transitions.length;p<q;p++) {
              var transition = transitions[p];
              var target = states[transition.target];

              var curve = curvedConnection(state.pos, target.pos, 80);

              var arrow = appendToSVG(stage, 'g', {class:'transition'});
              var line = appendToSVG(arrow,'path',{'d':quadraticString.apply(null, curve), fill: 'none', 'stroke-width': '7'});
              var head = appendToSVG(arrow,'polygon',{'points':curveArrowHead(curve, 50).join(',')});
            }
          }
        }

        var pt = stage.createSVGPoint();

        function cursorPoint(evt){
          pt.x = evt.clientX; pt.y = evt.clientY;
          return pt.matrixTransform(stage.getScreenCTM().inverse());
        }

        var dragStart = function(idx) {
          render();
        };
        var dragMove = function(element, deltaX, deltaY) {
          states[element].pos.x = clamp(states[element].pos.x + deltaX, 0, 1200);
          states[element].pos.y = clamp(states[element].pos.y + deltaY, 0, 600);

          render();
        };
        var dragEnd = function() {
          render();
        };

        var hit = function(evt, pos) {
          var idx = evt.target.getAttribute('stateIdx');

          return (idx || null) && parseInt(idx, 10);
        };

        var dragState = setupDrag(stage, cursorPoint, hit, dragStart, dragMove, dragEnd);

        return function() {
          setStageSize(stage, 1200, 600);
          render();
        };
      }

      var renderer = setup(document.getElementById('stage'));



      renderer();
    </script>
	</body>
</html>
